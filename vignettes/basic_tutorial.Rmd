---
title: "Basic Tutorial"
author: "Bob Verity"
date: "06/08/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This vignette demonstrates the use of the MALECOT package on a simple biallelic simulated data set, including installing the package, simulating some data, running the model and performing simple checks on the MCMC output.

## Installation

MALECOT relies on the Rcpp package, which requires the following OS-specific steps:

* Windows
    - Download and install the appropriate version of [Rtools](https://cran.rstudio.com/bin/windows/Rtools/) for your version of R. On installation, ensure you check the box to arrange your system PATH as recommended by Rtools
* Mac OS X
    - Download and install [XCode](http://itunes.apple.com/us/app/xcode/id497799835?mt=12)
    - Within XCode go to Preferences : Downloads and install the Command Line Tools
* Linux (Debian/Ubuntu)
    - Install the core software development utilities required for R package development as well as LaTeX by executing
    
            ```
            sudo apt-get install r-base-dev texlive-full
            ```

Next, in R, ensure that you have the devtools package installed by running
```{r, eval = FALSE}
install.packages("devtools", repos='http://cran.us.r-project.org')
```
Then we can simply install the *MALECOT* package directly from GitHub by running
```{r, eval = FALSE}
devtools::install_github("bobverity/MALECOT")
```
Finally, we need to load the package
```{r}
library(MALECOT)
```


## Simulating some data

MALECOT contains basic functions for simulating genetic data. The underlying model used in simulation is identical to that used in the inference step, meaning these simulations can be used to test the power and accuracy of the model in different settings.

We start by simulating a biallelic data set of 100 samples at 24 loci, drawn from 3 distinct subpopulations.

```{r}
sim1 <- sim_data(n = 100, L = 24, K = 3)
```

If we look inside this object using `names(sim1)` we will see that, in addition to the raw "data" element, the function returns the *true* value of the grouping, complexity of infection (m), and allele frequencies (p). These can be used to ground truth our inference, and check that the model is behaving as we expect. 

## Basic analysis

The analysis pipeline is built around MALECOT "projects", similar to the projects used in programs like STRUCTURE. This project will store all data, parameters, and output for a given analysis in one convenient location.

We start by creating a new project, and loading in the simulated data.

```{r, fig.show='hold'}
my_proj <- malecot_project()
my_proj <- bind_data(my_proj, data = sim1$data)
```

Notice that the `bind_data()` function takes a project as input, and returns the modified project as output - this will be the general format for all functions in the pipeline.

Next, we create a new parameter set. There are multiple model parameters that can be defined at this stage - we will use default settings but exploring a range of K (the number of subpopulations) from 1 to 5.
```{r}
my_proj <- new_set(my_proj, K = 1:5)
```

We can now run the main MCMC under these parameter settings. For the sake of this vignette we will use the option `silent = TRUE`, although in general it is useful to leave this option on to get a running progress update of the MCMC.
```{r}
my_proj <- run_mcmc(my_proj, burnin = 1e3, samples = 1e3, rungs = 1, silent = TRUE)
```

All output is stored within the `my_proj` object, and we can now produce plots of the posterior population assignment (i.e. "structure" plots), and the posterior complexity of infection of all samples.
```{r}
for (k in 1:5) {
  plot_q_matrix(my_proj, K = k, main = paste("K =", k))
  plot_m_quantiles(my_proj, K = k)
}
```

Test plot:
```{r}
plot(5)
```
