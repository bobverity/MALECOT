<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-allelic data • MALECOT</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Multi-allelic data">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MALECOT</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/tutorial-biallelic.html">Tutorial 1: bi-allelic data</a>
    </li>
    <li>
      <a href="../articles/complex-priors.html">Tutorial 2: more realistic models</a>
    </li>
    <li>
      <a href="../articles/multiallelic-data.html">Tutorial 3: multi-allelic data</a>
    </li>
    <li>
      <a href="../articles/comparing-models.html">Tutorial 4: comparing models</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced topics</li>
    <li>
      <a href="../articles/installation.html">Example article</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../articles/faq.html">FAQ</a>
</li>
<li>
  <a href="../articles/known-issues.html">Known issues</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bobverity/malecot">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Multi-allelic data</h1>
                        <h4 class="author">Bob Verity</h4>
            
            <h4 class="date">2018-09-24</h4>
      
      
      <div class="hidden name"><code>multiallelic-data.Rmd</code></div>

    </div>

    
    
<p>This vignette demonstrates the MALECOT analysis pipeline for multi-allelic data, i.e. data for which there are more than two alleles at a locus. It covers:</p>
<ol style="list-style-type: decimal">
<li>how multi-allelic format differs from bi-allelic format</li>
<li>binding multi-allelic data to a project and running a basic MCMC</li>
<li>checking MCMC behaviour</li>
<li>plotting results</li>
<li>more realistic priors on multi-allelic allele frequencies</li>
</ol>
<p>This tutorial assumes some prior knowledge about MALECOT, so if you are completely new to the program we recommend working through the simpler <a href="https://bobverity.github.io/MALECOT/articles/tutorial-biallelic.html">bi-allelic tutorial</a> first.</p>
<div id="loading-and-running-multi-allelic-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-and-running-multi-allelic-data" class="anchor"></a>Loading and running multi-allelic data</h2>
<p>The bi-allelic data format used in previous tutorials cannot be used for multi-allelic data because now we can observe more than just homozygous and heterozygous calls at a locus. Instead, if there are <em>J</em> alleles at a locus then we can observe any subset of these alleles, ranging from just a single allele to all <em>J</em> alleles. MALECOT accommodates this by reading in data in long format.</p>
<p>The easiest way to understand long format is to simulate some multi-allelic data. This can be done using the standard <code><a href="../reference/sim_data.html">sim_data()</a></code> function but with the argument <code>data_format = "multiallelic"</code>. As before, there are many elements that make up this simulated data including records of the true values used in simulation, but here we are only interested in the “data” element. Here we will draw data from 5 subpopulations covering a range of mean COIs from 1 to 5. We will assume that we have sequenced the samples at 10 loci, with each locus having 5 possible alleles. Finally, we will assume 10% missing data so we can see what missing data looks like in long format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mysim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sim_data.html">sim_data</a></span>(<span class="dt">data_format =</span> <span class="st">"multiallelic"</span>, <span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">L =</span> <span class="dv">10</span>, <span class="dt">K =</span> <span class="dv">5</span>, <span class="dt">COI_mean =</span> <span class="dv">1</span>:<span class="dv">5</span>,
                  <span class="dt">alleles =</span> <span class="dv">5</span>, <span class="dt">prop_missing =</span> <span class="fl">0.1</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(mysim$data)</code></pre></div>
<pre><code>##   sample_ID locus haplotype
## 1   samp001     1         3
## 2   samp001     2        -9
## 3   samp001     3        -9
## 4   samp001     4         4
## 5   samp001     5         5
## 6   samp001     6         4</code></pre>
<p>We can see that multi-allelic data has three columns, consisting of the sample ID, the locus, and the observed haplotype - the column names must match those shown above. The locus column must contain positive integer values starting at 1, meaning if loci are encoded as character strings then they must be converted to integers first. The same is true for haplotypes, which must be encoded as positive integers starting at 1 or as missing data.</p>
<p>Every locus must be represented in every sample - there can be no missing loci. Instead we can use the missing data character (-9 by default) to insert gaps in the data as needed. For example, in the simulated data above there is missing data in sample001 at loci 2 and 3, but this sample still has entries for all 10 loci rather than leaving these rows out entirely.</p>
<p>Once we have data in the correct format we need to create a new project and bind the data to the project using the <code><a href="../reference/bind_data_multiallelic.html">bind_data_multiallelic()</a></code> function. When binding data we have the option of specifying the number of alleles at each locus, or if this option is unspecified then the program uses the maximum observed value at that locus by default. This can give slightly different results, for example, imagine that we sequence 10 samples at a highly diverse locus which we know from previous work to have 8 possible alleles. With such a small sample it is quite possible that we will only observe the first 5 alleles by chance. If we bind the data without the <code>alleles</code> argument then the model will assume 5 alleles at this locus, whereas if we use the <code>alleles</code> argument we can tell the model that there are 8 alleles. This option is perhaps not so important when using real data, as we rarely know the number of alleles <em>a priori</em>, but it becomes very important when testing the power of the program on simulated data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create project and bind data, manually specifying the number of possible alleles</span>
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/malecot_project.html">malecot_project</a></span>()
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bind_data_multiallelic.html">bind_data_multiallelic</a></span>(myproj, <span class="dt">df =</span> mysim$data, <span class="dt">alleles =</span> <span class="dv">5</span>)</code></pre></div>
<p>We create parameter sets in the usual way, and with the same options for priors on COI. There is currently no error model implemented in the multi-allelic method, meaning arguments like <code>e1</code> and <code>e2</code> are ignored (this is something that may change in future versions of the program). We run the MCMC as before using the <code><a href="../reference/run_mcmc.html">run_mcmc()</a></code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create parameter set</span>
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/new_set.html">new_set</a></span>(myproj, <span class="dt">name =</span> <span class="st">"tutorial multiallelic"</span>, <span class="dt">COI_model =</span> <span class="st">"nb"</span>, <span class="dt">COI_max =</span> <span class="dv">20</span>,
                  <span class="dt">estimate_COI_mean =</span> <span class="ot">TRUE</span>, <span class="dt">COI_dispersion =</span> <span class="dv">2</span>, <span class="dt">lambda =</span> <span class="dv">1</span>)

<span class="co"># run MCMC</span>
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_mcmc.html">run_mcmc</a></span>(myproj, <span class="dt">K =</span> <span class="dv">5</span>, <span class="dt">burnin =</span> <span class="fl">1e4</span>, <span class="dt">converge_test =</span> <span class="fl">1e2</span>,
                   <span class="dt">samples =</span> <span class="fl">1e4</span>, <span class="dt">pb_markdown =</span>  <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Running MCMC for K = 5
## Burn-in phase
## 
  |                                                                       
  |=================================================================| 100%
##    converged within 300 iterations
## Sampling phase
## 
  |                                                                       
  |=================================================================| 100%
##    completed in 9.454 seconds
## 
## Processing results</code></pre>
<pre><code>## Total run-time: 10.73 seconds</code></pre>
<p>This MCMC will take longer than the bi-allelic MCMC because the likelihood calculation is considerably more complicated. It may also take longer to converge, and so we should keep an eye on the number of burn-in iterations.</p>
<p>As always we need to check the behaviour of our MCMC before moving on to results:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_loglike_dignostic.html">plot_loglike_dignostic</a></span>(myproj, <span class="dt">K =</span> <span class="dv">5</span>)</code></pre></div>
<p><img src="multiallelic-data_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/get_ESS.html">get_ESS</a></span>(myproj, <span class="dt">K =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>##    rung1 
## 636.3328</code></pre>
<p>Notice that the autocorrelation falls off much more slowly than under the bi-allelic MCMC, and the effective sample size is also quite small. We therefore should re-run the MCMC with a larger number of <code>samples</code>. For the sake of this tutorial we will save time by loading in results obtained by re-running this MCMC with <code>samples = 1e5</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load results</span>
myproj &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">"../inst/extdata/tutorial3_myproj2.rds"</span>)

<span class="co"># check behaviour</span>
<span class="kw"><a href="../reference/plot_loglike_dignostic.html">plot_loglike_dignostic</a></span>(myproj, <span class="dt">K =</span> <span class="dv">5</span>)</code></pre></div>
<p><img src="multiallelic-data_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/get_ESS.html">get_ESS</a></span>(myproj, <span class="dt">K =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>##    rung1 
## 4309.956</code></pre>
<p>We now mave a much more respectable effective sample size.</p>
</div>
<div id="plotting-results" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-results" class="anchor"></a>Plotting results</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># structure plot</span>
<span class="kw"><a href="../reference/plot_structure.html">plot_structure</a></span>(myproj, <span class="dt">K =</span> <span class="ot">NULL</span>, <span class="dt">divide_ind_on =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="multiallelic-data_files/figure-html/unnamed-chunk-11-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load ggplot2 package</span>
<span class="kw">library</span>(ggplot2)

<span class="co"># produce plot of posterior COIs</span>
posterior_COI &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_COI.html">plot_COI</a></span>(myproj, <span class="dt">K =</span> <span class="ot">NULL</span>)</code></pre></div>
<pre><code>## using K = 5 by default</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># overlay true COI values</span>
posterior_COI &lt;-<span class="st"> </span>posterior_COI +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> <span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">y =</span> mysim$true_m), <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">shape =</span> <span class="dv">4</span>)
posterior_COI</code></pre></div>
<p><img src="multiallelic-data_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<p>Posterior allele frequencies</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get group order</span>
group_order_k3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_group_order.html">get_group_order</a></span>(myproj, <span class="dt">K =</span> <span class="dv">5</span>, <span class="dt">target_group =</span> mysim$true_group)

<span class="co"># produce plot of posterior allele frequencies for this subpopulation</span>
posterior_p &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_p.html">plot_p</a></span>(myproj, <span class="dt">K =</span> <span class="ot">NULL</span>, <span class="dt">deme =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## using K = 5 by default</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get true simulated allele frequencies for this subpopulation</span>
sim_p &lt;-<span class="st"> </span><span class="kw">mapply</span>(function(x){x[group_order_k3[<span class="dv">1</span>], ]}, mysim$true_p, <span class="dt">SIMPLIFY =</span> <span class="ot">FALSE</span>)

<span class="co"># get plotting results into dataframe</span>
df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">locus =</span> <span class="kw">rep</span>(<span class="dv">1</span>:<span class="dv">10</span>, <span class="dt">each =</span> <span class="dv">5</span>),
                 <span class="dt">p =</span> <span class="kw">unlist</span>(sim_p),
                 <span class="dt">allele =</span> <span class="kw">rep</span>(<span class="dv">1</span>:<span class="dv">5</span>, <span class="dv">10</span>))

<span class="co"># overlay true allele frequencies onto plot</span>
posterior_p &lt;-<span class="st"> </span>posterior_p +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> locus, <span class="dt">y =</span> p, <span class="dt">group =</span> allele), <span class="dt">data =</span> df,
                                        <span class="dt">position =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/position_dodge">position_dodge</a></span>(<span class="dt">width =</span> <span class="fl">0.9</span>), <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">shape =</span> <span class="dv">4</span>)

posterior_p</code></pre></div>
<p><img src="multiallelic-data_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
</div>
<div id="more-realistic-prior-on-allele-frequencies" class="section level2">
<h2 class="hasAnchor">
<a href="#more-realistic-prior-on-allele-frequencies" class="anchor"></a>More realistic prior on allele frequencies</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_prior_p</span>(<span class="dt">lambda =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>))</code></pre></div>
<p><img src="multiallelic-data_files/figure-html/unnamed-chunk-14-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_prior_p</span>(<span class="dt">lambda =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)*<span class="dv">10</span>)</code></pre></div>
<p><img src="multiallelic-data_files/figure-html/unnamed-chunk-14-2.png" width="768"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#loading-and-running-multi-allelic-data">Loading and running multi-allelic data</a></li>
      <li><a href="#plotting-results">Plotting results</a></li>
      <li><a href="#more-realistic-prior-on-allele-frequencies">More realistic prior on allele frequencies</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bob Verity.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
