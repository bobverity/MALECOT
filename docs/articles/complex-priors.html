<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>More realistic models • MALECOT</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="More realistic models">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MALECOT</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/tutorial-biallelic.html">Tutorial 1: bi-allelic data</a>
    </li>
    <li>
      <a href="../articles/complex-priors.html">Tutorial 2: more realistic models</a>
    </li>
    <li>
      <a href="../articles/multiallelic-data.html">Tutorial 3: multi-allelic data</a>
    </li>
    <li>
      <a href="../articles/comparing-models.html">Tutorial 4: comparing models (estimating K)</a>
    </li>
    <li>
      <a href="../articles/running-in-parallel.html">Tutorial 5: running in parallel</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced topics</li>
    <li>
      <a href="../articles/ensuring-good-mixing.html">Ensuring good mixing</a>
    </li>
    <li>
      <a href="../articles/power-analysis-within-model.html">Power analysis - within model</a>
    </li>
    <li>
      <a href="../articles/power-analysis-between-models.html">Power analysis - between models</a>
    </li>
    <li>
      <a href="../articles/gti-mathematical-details.html">GTI mathematical details</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bobverity/malecot">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>More realistic models</h1>
                        <h4 class="author">Bob Verity</h4>
            
            <h4 class="date">2018-09-26</h4>
      
      
      <div class="hidden name"><code>complex-priors.Rmd</code></div>

    </div>

    
    
<p>This vignette demonstrates the use of more complex priors, which can add realism to the model but also tend to slow down the MCMC. It covers:</p>
<ol style="list-style-type: decimal">
<li>Different types of prior on COI</li>
<li>More realistic priors on allele frequencies</li>
<li>Dealing with missing data and estimating error rates</li>
</ol>
<p>This vignette follows on from the previous tutorial - or you can pick up here by running these lines of code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load output of previous tutorial</span>
mysim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/malecot_file.html">malecot_file</a></span>(<span class="st">"tutorial1_mysim.rds"</span>)
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/malecot_file.html">malecot_file</a></span>(<span class="st">"tutorial1_myproj.rds"</span>)</code></pre></div>
<div id="more-realistic-priors-on-coi" class="section level2">
<h2 class="hasAnchor">
<a href="#more-realistic-priors-on-coi" class="anchor"></a>More realistic priors on COI</h2>
<p>In the previous tutorial we assumed a uniform prior on COI. This tends to be too permissive for real data as it gives considerable weight to high COIs and can therefore lead to over-estimation. There are two alternative priors implemented in MALECOT - the <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson distribution</a> and the <a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution">negative binomial distribution</a>.</p>
<p>The Poisson distribution assumes that COIs are clustered around a mean value. It is what we would expect if all individuals in the population were becoming infected and clearing infections at the same constant rate. The negative binomial distribution can be thought of as an over-dispersed form of Poisson distribution, i.e. it allows for a greater spread of values around the mean. It more closely reflects a situation where there is heterogeneity in exposure, meaning some individuals tend to be heavily infected while some are only lightly infected. We can use the parameter <code>COI_dispersion</code> to set the level of over-dispersion - for example, a value of 2 means the prior variance will be twice as large as the prior mean. Note that whatever prior we choose, COIs will still be truncated at <code>COI_max</code>.</p>
<p>We can explore different shapes of prior using the <code><a href="../reference/plot_prior_COI.html">plot_prior_COI()</a></code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_prior_COI.html">plot_prior_COI</a></span>(<span class="dt">COI_model =</span> <span class="st">"uniform"</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-3-1.png" width="384"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_prior_COI.html">plot_prior_COI</a></span>(<span class="dt">COI_model =</span> <span class="st">"poisson"</span>, <span class="dt">COI_mean =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-3-2.png" width="384"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_prior_COI.html">plot_prior_COI</a></span>(<span class="dt">COI_model =</span> <span class="st">"nb"</span>, <span class="dt">COI_mean =</span> <span class="dv">3</span>, <span class="dt">COI_dispersion =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-3-3.png" width="384"></p>
<p>The simulated data in the previous tutorial were generated from a Poisson distribution, and so we could use this prior to exactly match the inference model to the simulated data. However, in reality we will not have the luxury of knowing the true COI distribution, and so for this example we will use a negative binomial prior. Rather than using a set value for the prior mean we will use the argument <code>estimate_COI_mean = TRUE</code> to tell the model that we want to estimate the mean COI for each subpopulation.</p>
<p>In some cases we may want to specify the COI of certain samples manually - for example if we have already used other programs to estimate the COI and we want to insert these values. This can be accommodated using the <code>COI_manual</code> argument, which takes a vector of length equal to the number of samples. Values of -1 indicate that the COI should be estimated, while positive values indicate that the COI should be fixed at that value. In this example we will assume that we know the true COIs of the last 10 samples.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define some COIs manually</span>
known_COI &lt;-<span class="st"> </span><span class="kw">rep</span>(-<span class="dv">1</span>,<span class="dv">100</span>)
known_COI[<span class="dv">91</span>:<span class="dv">100</span>] &lt;-<span class="st"> </span>mysim$true_m[<span class="dv">91</span>:<span class="dv">100</span>]

<span class="co"># create new parameter set</span>
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/new_set.html">new_set</a></span>(myproj, <span class="dt">name =</span> <span class="st">"nb model"</span>, <span class="dt">COI_model =</span> <span class="st">"nb"</span>, <span class="dt">COI_max =</span> <span class="dv">20</span>,
                  <span class="dt">COI_manual =</span> known_COI, <span class="dt">estimate_COI_mean =</span> <span class="ot">TRUE</span>, <span class="dt">COI_dispersion =</span> <span class="dv">2</span>)
myproj</code></pre></div>
<pre><code>## DATA:
##    data format = biallelic
##    samples = 100
##    loci = 24
##    pops = 3
##    missing data = 0 of 2400 gene copies (0%)
## 
## PARAMETER SETS:
##    SET1: uniform model
##  * SET2: nb model
## 
## ACTIVE SET: SET2
##    lambda = 1
##    COI model = nb
##    COI max = 20
##    COI specified manually for 10 samples
##    estimate COI mean = TRUE
##    COI dispersion = 2
##    estimate error = FALSE
##    e1 = 0
##    e2 = 0</code></pre>
<p>We will keep things simple here by only running the MCMC for <span class="math inline">\(K = 3\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># run MCMC</span>
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_mcmc.html">run_mcmc</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">burnin =</span> <span class="fl">1e4</span>, <span class="dt">converge_test =</span> <span class="fl">1e2</span>,
                   <span class="dt">samples =</span> <span class="fl">1e4</span>, <span class="dt">pb_markdown =</span>  <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Running MCMC for K = 3
## Burn-in phase
## 
  |                                                                       
  |=================================================================| 100%
##    converged within 100 iterations
## 3.41798 2.01049 2.0683 2.69213 2.42659 2.91708 3.96894 2.00287 2.40639 2.37312 1.57719 2.80229 1.75943 2.26298 3.35931 2.9944 3.22408 2.71194 3.18163 2.8937 3.10306 2.64969 3.29561 2.46973 2.37939 1.70308 2.3564 2.76966 3.1011 2.88147 2.47295 1.9549 1.43411 2.89764 2.64085 4.11611 3.75117 3.15671 4.0679 2.33234 3.73506 1.72637 2.23605 1.77137 4.69799 3.61291 3.27988 2.67787 2.00341 4.65677 5.37551 3.64929 2.02236 1.94297 2.44551 3.10718 2.76676 2.65623 2.86689 2.56253 2.85876 3.49519 4.08991 3.81948 3.05242 2.45356 2.25677 1.85695 4.98484 3.58715 4.22299 2.41815 3.54143 3.52937 4.32274 4.32987 4.23973 3.19526 3.74453 3.33414 5.01115 3.87198 5.23976 1.97174 5.66922 3.51582 2.25038 2.47722 3.88014 3.55969 2 2 2 2 2 2 2 2 2 2 
## Sampling phase
## 
  |                                                                       
  |=================================================================| 100%
##    completed in 3.2339 seconds
## 
## Processing results</code></pre>
<pre><code>## Total run-time: 3.91 seconds</code></pre>
<p>As before, we need to check that we are happy with the behaviour of our MCMC by looking at trace plots and other diagnostics. Assuming everything looks OK, we can go ahead and produce the posterior allocation and and posterior COI plots:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># structure plot</span>
<span class="kw"><a href="../reference/plot_structure.html">plot_structure</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">divide_ind_on =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-7-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load ggplot2 package</span>
<span class="kw">library</span>(ggplot2)

<span class="co"># produce plot of posterior COIs</span>
posterior_COI &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_COI.html">plot_COI</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>)

<span class="co"># overlay true COI values</span>
posterior_COI &lt;-<span class="st"> </span>posterior_COI +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> <span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">y =</span> mysim$true_m), <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">shape =</span> <span class="dv">4</span>)
posterior_COI</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
<p>Notice that the 95% credible intervals in the COI plot are tighter than the equivalent plot of the previous tutorial. This is because our prior now assumes that COIs are clustered around a mean value. Notice also that the final ten samples have their COI fixed at the correct value due to our use of the <code>COI_manual</code> argument.</p>
<p>Next we can look at the estimated mean COI for each of the subpopulations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_COI_mean.html">plot_COI_mean</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-9-1.png" width="480"></p>
<p>Recall that the data were simulated from three subpopulations with true mean COIs of 1.2, 2, and 3 respectively. The model appears to have estimated the correct values, but in the wrong order. The seemingly incorrect order of these estimates goes back to the issue of labelling subpopulations mentioned in the previous tutorial. When lined up against the three groups in the structure plot above (which go group3 then group2 then group1) we can see that mean COI estimates do in fact go from lowest on the left to highest on the right. We can also specify the deme order in this plot using the <code>deme_order</code> argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_COI_mean.html">plot_COI_mean</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">deme_order =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>))</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-11-1.png" width="480"></p>
</div>
<div id="more-realistic-priors-on-allele-frequencies" class="section level2">
<h2 class="hasAnchor">
<a href="#more-realistic-priors-on-allele-frequencies" class="anchor"></a>More realistic priors on allele frequencies</h2>
<p>The distribution of allele frequencies can be an important factor in determining how much signal there is in the data. If allele frequencies have a narrow range then even subpopulations that are evolutionarily well separated might look similar, and so it becomes difficult to detect population structure. Similarly, if our model expects subpopulations to have very different allele frequencies then it might ignore more subtle differences, tending instead to lump subpopulations together.</p>
<p>MALECOT assumes a <a href="https://en.wikipedia.org/wiki/Beta_distribution">beta prior</a> on allele frequencies with shape parameter <code>lambda</code>. We have three options when specifying <code>lambda</code>:</p>
<ol style="list-style-type: decimal">
<li><p><code>lambda</code> can be a single value. In this case the same shape parameter is used for all alleles and all loci, making the prior symmetric and identical over all loci.</p></li>
<li><p><code>lambda</code> can be a vector of shape parameters - one for each allele. In this case the prior will usually be asymmetric and skewed in favour of one allele. The same prior is still applied over all loci, meaning this option can only be used if there are the same number of alleles at every locus (this is always true for bi-allelic data).</p></li>
<li><p><code>lambda</code> can be a list with as many elements as there are loci, and each element consisting of a vector with as many elements as there are alleles at that locus. This makes it possible to specify a different prior at every locus.</p></li>
</ol>
<p>By default, <code>lambda</code> is defined using the first method with a value of 1. This places equal weight on every allele frequency in the interval <span class="math inline">\([0,1]\)</span> at every locus, i.e. the Beta distribution simplifies to the uniform distribution. We can visualise different priors using the <code><a href="../reference/plot_prior_p.html">plot_prior_p()</a></code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># (the default prior)</span>
<span class="kw"><a href="../reference/plot_prior_p.html">plot_prior_p</a></span>(<span class="dt">lambda =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-13-1.png" width="384"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_prior_p.html">plot_prior_p</a></span>(<span class="dt">lambda =</span> <span class="fl">0.5</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-13-2.png" width="384"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_prior_p.html">plot_prior_p</a></span>(<span class="dt">lambda =</span> <span class="kw">c</span>(<span class="dv">7</span>,<span class="dv">1</span>))</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-13-3.png" width="384"></p>
<p>We will use the last of these distributions, which makes it more likely <em>a priori</em> that the reference allele will be common and the alternative allele will be rare. We can simulate some new data under this prior and load it into a new project:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># simulate new data with skewed allele frequency distribution</span>
mysim_skew &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sim_data.html">sim_data</a></span>(<span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">L =</span> <span class="dv">24</span>, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">lambda =</span> <span class="kw">c</span>(<span class="dv">7</span>,<span class="dv">1</span>))

<span class="co"># bind data to new project</span>
myproj_skew &lt;-<span class="st"> </span><span class="kw"><a href="../reference/malecot_project.html">malecot_project</a></span>()
myproj_skew &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bind_data_biallelic.html">bind_data_biallelic</a></span>(myproj_skew, <span class="dt">df =</span> mysim_skew$data, <span class="dt">ID_col =</span> <span class="dv">1</span>, <span class="dt">pop_col =</span> <span class="dv">2</span>)</code></pre></div>
<p>Next we need a parameter set. When defining the prior on allele frequencies we will use the same skewed distribution that we used when generating the data. We then run the MCMC as normal:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define parameter set with skewed prior</span>
myproj_skew &lt;-<span class="st"> </span><span class="kw"><a href="../reference/new_set.html">new_set</a></span>(myproj_skew, <span class="dt">name =</span> <span class="st">"skew allele freqs"</span>, <span class="dt">COI_model =</span> <span class="st">"poisson"</span>,
                       <span class="dt">COI_max =</span> <span class="dv">20</span>, <span class="dt">estimate_COI_mean =</span> <span class="ot">TRUE</span>, <span class="dt">lambda =</span> <span class="kw">c</span>(<span class="dv">7</span>,<span class="dv">1</span>))

<span class="co"># run the MCMC</span>
myproj_skew &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_mcmc.html">run_mcmc</a></span>(myproj_skew, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">burnin =</span> <span class="fl">1e4</span>, <span class="dt">converge_test =</span> <span class="fl">1e2</span>,
                          <span class="dt">samples =</span> <span class="fl">1e4</span>, <span class="dt">pb_markdown =</span>  <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Running MCMC for K = 3
## Burn-in phase
## 
  |                                                                       
  |=================================================================| 100%
##    converged within 100 iterations
## 4.04727 5.73336 3.8457 5.19779 5.40735 4.39847 5.3575 4.07457 3.19661 5.20825 4.71131 5.22818 4.58218 4.89539 4.06163 4.08152 4.78489 4.66565 5.00567 2.75655 6.05073 5.49495 4.93046 4.75443 5.27722 5.05412 5.49195 2.80463 4.38846 4.43364 2.47247 2.95856 3.1785 3.19704 2.47545 3.11763 3.34214 4.80614 4.34137 3.34733 3.49858 2.28481 4.96436 4.00105 3.88795 3.8085 3.88653 3.15548 2.75616 5.78835 4.27854 3.33755 1.8496 1.37458 4.32028 3.06848 2.97053 3.43244 3.48675 3.4332 4.28533 4.70759 4.23687 3.27518 2.03297 3.10332 4.63257 2.50267 3.14708 1.07345 4.95779 4.19181 4.81006 4.22887 3.57246 3.98826 3.94327 4.89667 5.47164 1.60332 6.45929 4.18556 2.06531 3.66127 4.94935 3.24859 2.97327 2.89518 4.87745 4.06143 4.31735 4.65096 2.9285 3.96937 2.6357 4.5265 5.11963 4.59203 4.51188 4.14147 
## Sampling phase
## 
  |                                                                       
  |=================================================================| 100%
##    completed in 2.12538 seconds
## 
## Processing results</code></pre>
<pre><code>## Total run-time: 2.51 seconds</code></pre>
<p>After checking that our MCMC has behaved as expected, we can look at the posterior allocation plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># structure plot</span>
<span class="kw"><a href="../reference/plot_structure.html">plot_structure</a></span>(myproj_skew, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">divide_ind_on =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-16-1.png" width="768"></p>
<p>We can see that the model has struggled slightly to pull apart the population structure. This is due to there being less information in 24 loci with skewed allele frequencies than in 24 loci with evenly spread allele frequencies.</p>
<p>Plotting credible intervals of posterior allele frequencies and overlaying the true simulated values, as demonstrated in the previous tutorial, we see that the model has done a good job of estimating the allele frequencies:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get group order</span>
group_order_k3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_group_order.html">get_group_order</a></span>(myproj_skew, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">target_group =</span> mysim_skew$true_group)

<span class="co"># loop through subpopulations</span>
for (i in <span class="dv">1</span>:<span class="dv">3</span>) {
  
  <span class="co"># produce plot of posterior allele frequencies for this subpopulation</span>
  posterior_p &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_p.html">plot_p</a></span>(myproj_skew, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">deme =</span> i)
  
  <span class="co"># get true simulated allele frequencies for this subpopulation</span>
  sim_p &lt;-<span class="st"> </span><span class="kw">mapply</span>(function(x){x[group_order_k3[i],<span class="dv">1</span>]}, mysim_skew$true_p)
  
  <span class="co"># overlay true allele frequencies onto plot</span>
  posterior_p &lt;-<span class="st"> </span>posterior_p +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> <span class="dv">1</span>:<span class="dv">24</span>, <span class="dt">y =</span> sim_p), <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">shape =</span> <span class="dv">4</span>)
  <span class="kw">print</span>(posterior_p)
}</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-17-1.png" width="576"><img src="complex-priors_files/figure-html/unnamed-chunk-17-2.png" width="576"><img src="complex-priors_files/figure-html/unnamed-chunk-17-3.png" width="576"></p>
<p>If we had used a uniform prior then the posterior allele frequencies would have been slightly biased towards the middle, although the overall inferred population structure would probably have been similar.</p>
</div>
<div id="missing-data-and-errors" class="section level2">
<h2 class="hasAnchor">
<a href="#missing-data-and-errors" class="anchor"></a>Missing data and errors</h2>
<p>Real data is rarely without errors. Often true homozygotes will be miscalled as heterozygotes (error 1), and true heterozygotes will be miscalled as homozygotes (error 2). The probabilities of these two types of error can be specified in MALECOT using the arguments <code>e1</code> and <code>e2</code>. We can either use fixed values, or these error probabilities can be estimated by setting <code>estimate_error = TRUE</code>, in which case a uniform prior is assumed ranging from 0 to <code>e1_max</code> for <code>e1</code>, and 0 to <code>e2_max</code> for <code>e2</code>.</p>
<p>Let us simulate some new data containing errors to test the model in a more challenging setting. We will assume that artificial heterozygotes occur with probability 0.1, and artificial homozygotes with probability 0.05. We will also assume that 20% of the data is missing, and hence encoded as <code>-9</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># simulate data</span>
mysim_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sim_data.html">sim_data</a></span>(<span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">L =</span> <span class="dv">24</span>, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">e1 =</span> <span class="fl">0.1</span>, <span class="dt">e2 =</span> <span class="fl">0.05</span>, <span class="dt">prop_missing =</span> <span class="fl">0.2</span>)
<span class="kw">head</span>(mysim_errors$data)</code></pre></div>
<pre><code>##   sample_ID pop locus1 locus2 locus3 locus4 locus5 locus6 locus7 locus8
## 1   samp001   1    1.0    1.0    1.0    1.0    0.5    0.5    0.0    0.5
## 2   samp002   1    1.0    1.0    1.0    0.5    0.5    0.5    0.5    0.0
## 3   samp003   1    0.5    1.0    0.5    1.0   -9.0    0.0    1.0    1.0
## 4   samp004   1    0.5    0.5    1.0    0.5    0.5    1.0   -9.0    0.5
## 5   samp005   1    1.0    0.5   -9.0    0.5   -9.0    1.0    0.5    0.0
## 6   samp006   1    1.0    0.5    1.0    0.5    0.5    0.5    0.5   -9.0
##   locus9 locus10 locus11 locus12 locus13 locus14 locus15 locus16 locus17
## 1    0.5     1.0     0.0     0.5     1.0     0.0      -9     0.5     0.0
## 2    0.0    -9.0    -9.0     0.0     1.0     0.5       1     0.0    -9.0
## 3    0.0     0.5    -9.0     1.0    -9.0     0.0       1     0.0     0.0
## 4    0.5     0.5     0.5     0.5     0.5     0.5       1    -9.0    -9.0
## 5    0.5     1.0     0.5     0.5     0.5    -9.0       1     0.5     0.5
## 6    0.5     1.0    -9.0    -9.0     1.0     0.0       1    -9.0     0.0
##   locus18 locus19 locus20 locus21 locus22 locus23 locus24
## 1     0.0     0.5     1.0       0     1.0     0.5     1.0
## 2    -9.0    -9.0     1.0       0     1.0     1.0     0.0
## 3     1.0     1.0     0.5      -9     1.0     1.0     0.0
## 4     0.5     0.5     0.5       0    -9.0     0.5    -9.0
## 5     0.0     0.0     0.5      -9     0.5     0.0     0.5
## 6     0.5     0.5    -9.0       0     0.5    -9.0     0.5</code></pre>
<p>Next we will create a new project and bind the new data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># bind data to new project</span>
myproj_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/malecot_project.html">malecot_project</a></span>()
myproj_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bind_data_biallelic.html">bind_data_biallelic</a></span>(myproj_errors, mysim_errors$data, <span class="dt">ID_col =</span> <span class="dv">1</span>, <span class="dt">pop_col =</span> <span class="dv">2</span>)
myproj_errors</code></pre></div>
<pre><code>## DATA:
##    data format = biallelic
##    samples = 100
##    loci = 24
##    pops = 3
##    missing data = 480 of 2400 gene copies (20%)
## 
## PARAMETER SETS:
##    (none defined)</code></pre>
<p>Looking at this output we can see that the project has correctly registered 20% of the data as missing.</p>
<p>For the model, we will assume a maximum value of 0.2 for both <code>e1</code> and <code>e2</code>. It is recommended to use sensible values for <code>e1_max</code> and <code>e2_max</code>, for example values of <code>1.0</code> are usually inappropriate as we (hopefully) do not expect all of our data to be mistakes! We then run the MCMC as usual:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create new parameter set</span>
myproj_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/new_set.html">new_set</a></span>(myproj_errors, <span class="dt">name =</span> <span class="st">"error model"</span>, <span class="dt">COI_model =</span> <span class="st">"poisson"</span>,
                         <span class="dt">COI_max =</span> <span class="dv">20</span>, <span class="dt">estimate_COI_mean =</span> <span class="ot">TRUE</span>,
                         <span class="dt">estimate_error =</span> <span class="ot">TRUE</span>, <span class="dt">e1_max =</span> <span class="fl">0.2</span>, <span class="dt">e2_max =</span> <span class="fl">0.2</span>)

<span class="co"># run the MCMC</span>
myproj_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_mcmc.html">run_mcmc</a></span>(myproj_errors, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">burnin =</span> <span class="fl">1e4</span>, <span class="dt">converge_test =</span> <span class="fl">1e2</span>,
                          <span class="dt">samples =</span> <span class="fl">1e4</span>, <span class="dt">pb_markdown =</span>  <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Running MCMC for K = 3
## Burn-in phase
## 
  |                                                                       
  |=================================================================| 100%
##    converged within 200 iterations
## 4.9292 4.08347 3.73598 7.32888 5.89465 6.65381 7.17359 6.77103 5.69031 5.96569 5.12659 6.50995 7.61517 2.707 5.80186 5.61322 6.29645 6.91396 3.43291 4.10677 6.15754 6.20569 5.90418 7.59957 6.78337 4.57179 5.75071 4.17896 6.12776 3.86638 3.98279 6.23394 5.64933 5.34227 5.38944 6.04426 7.17803 6.68859 7.0898 6.21662 2.8336 6.95164 6.90956 5.87884 4.49036 6.30962 6.70172 6.00838 3.64215 6.79314 6.39789 5.46336 6.45262 6.04493 6.46634 6.32683 4.57731 5.07119 6.31463 5.37016 6.34085 6.49255 5.66644 5.03082 4.3096 6.14043 3.93433 5.58535 6.27222 6.39412 5.61615 6.93386 5.27161 6.09138 7.55707 5.77747 3.34681 5.59465 4.82102 5.23326 5.14454 4.88617 5.73108 3.03002 5.17266 5.07034 6.33872 6.68072 4.42798 5.49019 6.94194 7.69288 5.42731 5.48768 2.75185 6.47272 7.42703 5.12319 4.44386 5.83171 
## Sampling phase
## 
  |                                                                       
  |=================================================================| 100%
##    completed in 3.52522 seconds
## 
## Processing results</code></pre>
<pre><code>## Total run-time: 3.89 seconds</code></pre>
<p>After checking the behaviour of our MCMC we can plot the posterior 95% credible intervals of <code>e1</code> and <code>e2</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_e.html">plot_e</a></span>(myproj_errors)</code></pre></div>
<pre><code>## using K = 3 by default</code></pre>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-22-1.png" width="384"></p>
<p>In this example the model has been able to correctly infer the error rates of around 0.1 and 0.05 from the data. To help get an intuition as to how the model is able to do this, imagine a situation where every locus in a given sample is homozygous apart from one which is heterozygous. There are two possibilities here: 1) the heterozygous locus is due to that sample having COI of 2 and being homozygous everywhere else by chance, 2) the heterozygous call is an error and the sample actually has COI of 1. The probability of being homozygous at every other locus by chance may be very small if the allele frequencies are intermediate, in which case the weight of evidence is in favour of this one heterozygous call being an error. The MCMC considers all possibilities in proportion to their likelihood, and weighted by our prior beliefs, to arrive at the posterior distributions above.</p>
<p>The <a href="https://bobverity.github.io/MALECOT/articles/multiallelic-data.html">next tutorial</a> explores how the analysis pipeline differs when using multi-allelic data.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#more-realistic-priors-on-coi">More realistic priors on COI</a></li>
      <li><a href="#more-realistic-priors-on-allele-frequencies">More realistic priors on allele frequencies</a></li>
      <li><a href="#missing-data-and-errors">Missing data and errors</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bob Verity.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
