<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial 2: more realistic data and priors • MALECOT</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial 2: more realistic data and priors">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MALECOT</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/tutorial-biallelic.html">Tutorial 1: bi-allelic data</a>
    </li>
    <li>
      <a href="../articles/complex-priors.html">Tutorial 2: more realistic models</a>
    </li>
    <li>
      <a href="../articles/tutorial-multiallelic.html">Tutorial 3: multi-allelic data</a>
    </li>
    <li>
      <a href="../articles/comparing-models.html">Tutorial 4: comparing models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../articles/faq.html">FAQ</a>
</li>
<li>
  <a href="../articles/known-issues.html">Known issues</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bobverity/malecot">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Tutorial 2: more realistic data and priors</h1>
                        <h4 class="author">Bob Verity</h4>
            
            <h4 class="date">2018-09-17</h4>
      
      
      <div class="hidden name"><code>complex-priors.Rmd</code></div>

    </div>

    
    
<p>This vignette demonstrates the use of more complex priors, which can add realism to the model but also tend to slow down the MCMC. It covers:</p>
<ul>
<li>different types of prior on COI</li>
<li>more realistic priors on allele frequencies</li>
<li>dealing with missing data and errors</li>
</ul>
<p>This vignette follows on from the previous tutorial - or you can pick up here by running these lines:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load output of previous tutorial</span>
mysim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/malecot_file.html">malecot_file</a></span>(<span class="st">"tutorial1_mysim.rds"</span>)
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/malecot_file.html">malecot_file</a></span>(<span class="st">"tutorial1_myproj.rds"</span>)</code></pre></div>
<div id="more-complex-priors-on-coi" class="section level3">
<h3 class="hasAnchor">
<a href="#more-complex-priors-on-coi" class="anchor"></a>More complex priors on COI</h3>
<p>The previous model assumed a uniform prior on COI. This tends to be too permissive for real data as it gives considerable weight to high COIS and can therefore lead to over-estimation. There are two alternative priors implemented in MALECOT - the <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson distribution</a> and the <a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution">negative binomial distribution</a>.</p>
<p>The Poisson distribution assumes that COIs are clustered around a mean value. It is what we would expect if all individuals in the population were becoming infected and clearing infections at the same constant rate. The negative binomial distribution can be thought of as an over-dispersed Poisson distribution (i.e. it allows for a greater spread of values around the mean). It more closely reflects a situation where there is heterogeneity in exposure, meaning some individuals tend to be heavily infected and some only lightly infected. Note that whaterver prior we choose, COIs will still be truncated at <code>COI_max</code>.</p>
<p>The simulated data were generated from a Poisson distribution, and so we could use this prior to exactly match the inference model to the simulated data. However, in reality we will not have this luxury, and so here we will use a negative binomial prior. We can use the parameter <code>COI_dispersion</code> to set the level of over-dispersion compared to the Poisson distribution - for example, a value of 2 means the prior variance will be twice that of the Poisson distribution. The argument <code>COI_mean = TRUE</code> tells the model that we want to estimate the mean COI for each subpopulation, rather than using a set value.</p>
<p>In some cases we may want to specify the COI of certain samples manually - for example if we have used other programs to estimate the COI using different methods. This can be accommodated using the <code>COI_manual</code> argument, which takes a vector of length equal to the number of samples. Values of -1 indicate that the COI should be estimated, while positive values indicate that the COI should be fixed at that value. In this example we will assume that we know the true COIs of the last 10 samples.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define some COIs manually</span>
known_COI &lt;-<span class="st"> </span><span class="kw">rep</span>(-<span class="dv">1</span>,<span class="dv">100</span>)
known_COI[<span class="dv">91</span>:<span class="dv">100</span>] &lt;-<span class="st"> </span>mysim$true_m[<span class="dv">91</span>:<span class="dv">100</span>]

<span class="co"># create new parameter set</span>
myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/new_set.html">new_set</a></span>(myproj, <span class="dt">name =</span> <span class="st">"nb model"</span>, <span class="dt">COI_model =</span> <span class="st">"nb"</span>, <span class="dt">COI_max =</span> <span class="dv">20</span>,
                  <span class="dt">COI_manual =</span> known_COI, <span class="dt">estimate_COI_mean =</span> <span class="ot">TRUE</span>, <span class="dt">COI_dispersion =</span> <span class="dv">2</span>,
                  <span class="dt">estimate_error =</span> <span class="ot">FALSE</span>, <span class="dt">e1 =</span> <span class="fl">0.0</span>, <span class="dt">e2 =</span> <span class="fl">0.0</span>)
myproj</code></pre></div>
<pre><code>## DATA:
##    data format = biallelic
##    samples = 100
##    loci = 24
##    pops = 3
##    missing data = 0 of 2400 gene copies (0%)
## 
## PARAMETER SETS:
##    SET1: uniform model
##  * SET2: nb model
## 
## ACTIVE SET: SET2
##    lambda = 1
##    COI model = nb
##    COI max = 20
##    COI specified manually for 10 samples
##    estimate COI mean = TRUE
##    COI dispersion = 2
##    estimate error = FALSE
##    e1 = 0
##    e2 = 0</code></pre>
<p>As before, we run the MCMC using the <code><a href="../reference/run_mcmc.html">run_mcmc()</a></code> command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">myproj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_mcmc.html">run_mcmc</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">burnin =</span> <span class="fl">1e4</span>, <span class="dt">converge_test =</span> <span class="fl">1e2</span>,
                   <span class="dt">samples =</span> <span class="fl">1e3</span>, <span class="dt">pb_markdown =</span>  <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Running MCMC for K = 3
## Burn-in phase
## 
  |                                                                       
  |=================================================================| 100%
##    converged within 100 iterations
## Sampling phase
## 
  |                                                                       
  |=================================================================| 100%
##    completed in 0.364835 seconds
## 
## Processing results</code></pre>
<pre><code>## Total run-time: 0.87 seconds</code></pre>
<p>As before, we need to check that we are happy with the behaviour of our MCMC by looking at GTI paths, trace plots, and any other useful diagnostics. Assuming everything looks OK, we can go ahead and produce the structure and posterior COI plots:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># structure plot</span>
<span class="kw"><a href="../reference/plot_qmatrix.html">plot_qmatrix</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">divide_ind_on =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot posterior COIs</span>
posterior_m &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_m_quantiles.html">plot_m_quantiles</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>)

<span class="co"># overlay true values</span>
<span class="kw">library</span>(ggplot2)
posterior_m &lt;-<span class="st"> </span>posterior_m +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> <span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">y =</span> mysim$true_m), <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">shape =</span> <span class="dv">4</span>)
posterior_m</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<p>Notice that the 95% credible intervals in this plot are tighter than in the previous tutorial. This is because our prior now assumes that COIs are clustered around a mean value for each subpopulation. Notice also that the final 10 samples have their COI fixed at the correct value, as specified by the <code>COI_manual</code> argument.</p>
<p>Next we can look at the estimated mean COI for each of the subpopulations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_COI_mean_quantiles.html">plot_COI_mean_quantiles</a></span>(myproj, <span class="dt">K =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Recall that the data were simulated from three subpopulations with true mean COIs of 1.2, 2, and 3 respectively. The model appears to have estimated roughly the same values, although in a different order. We can understand the ordering issue by looking at the structure plot above. In the structure plot, groupings read from left to right go 2, then 3, then 1; the reason being that MALECOT chooses groupings to make outputs as similar as possible over different values of <em>K</em>. If we read the mean COI estimates in this order (2,3,1) we can see that the model has indeed estimated the correct values.</p>
</div>
<div id="more-realistic-priors-on-allele-frequencies" class="section level3">
<h3 class="hasAnchor">
<a href="#more-realistic-priors-on-allele-frequencies" class="anchor"></a>More realistic priors on allele frequencies</h3>
<p>(TODO)</p>
</div>
<div id="missing-data-and-errors" class="section level3">
<h3 class="hasAnchor">
<a href="#missing-data-and-errors" class="anchor"></a>Missing data and errors</h3>
<p>We do not always want to assume that we have zero error in our data. Often true homozygotes will be miscalled as heterozygotes (error 1), and true heterozygotes will be miscalled as homozygotes (error 2). The probabilities of these two types of error can be specified in the model using the arguments <code>e1</code> and <code>e2</code>. We can either use fixed values, or these error probabilities can be estimated by setting <code>estimate_error = TRUE</code>, in which case a uniform prior is assumed ranging from 0 to <code>e1_max</code> for <code>e1</code>, and 0 to <code>e2_max</code> for <code>e2</code>. It is recommended to use sensible values for <code>e1_max</code> and <code>e2_max</code> (for example values of <code>1.0</code> are usually inappropriate as we do not expect all of our data to be mistakes).</p>
<p>Let us simulate some data with errors to test the model in a more challenging setting. We will assume that artificial heterozygotes occur with probability 0.1, and artificial homozygotes with probability 0.05. We will also assume that 20% of the data is missing, and hence encoded as <code>-9</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mysim_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sim_data.html">sim_data</a></span>(<span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">L =</span> <span class="dv">24</span>, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">e1 =</span> <span class="fl">0.1</span>, <span class="dt">e2 =</span> <span class="fl">0.05</span>, <span class="dt">prop_missing =</span> <span class="fl">0.2</span>)</code></pre></div>
<p>Next we will create a new project and bind the new data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">myproj_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/malecot_project.html">malecot_project</a></span>()
myproj_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bind_data_biallelic.html">bind_data_biallelic</a></span>(myproj_errors, mysim_errors$data, <span class="dt">ID_col =</span> <span class="dv">1</span>, <span class="dt">pop_col =</span> <span class="dv">2</span>)
myproj_errors</code></pre></div>
<pre><code>## DATA:
##    data format = biallelic
##    samples = 100
##    loci = 24
##    pops = 3
##    missing data = 480 of 2400 gene copies (20%)
## 
## PARAMETER SETS:
##    (none defined)</code></pre>
<p>Looking at this output we can see that the project has correctly registered 20% of the data as missing.</p>
<p>For the model, we will assume a Poisson prior on the COI and a maximum value of 0.2 in both <code>e1</code> and <code>e2</code>. We then run the MCMC as usual:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create new parameter set</span>
myproj_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/new_set.html">new_set</a></span>(myproj_errors, <span class="dt">name =</span> <span class="st">"errors"</span>, <span class="dt">COI_model =</span> <span class="st">"poisson"</span>,
                         <span class="dt">COI_max =</span> <span class="dv">20</span>, <span class="dt">estimate_COI_mean =</span> <span class="ot">TRUE</span>,
                         <span class="dt">estimate_error =</span> <span class="ot">TRUE</span>, <span class="dt">e1_max =</span> <span class="fl">0.2</span>, <span class="dt">e2_max =</span> <span class="fl">0.2</span>)

myproj_errors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_mcmc.html">run_mcmc</a></span>(myproj_errors, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">burnin =</span> <span class="fl">1e4</span>, <span class="dt">converge_test =</span> <span class="fl">1e2</span>,
                          <span class="dt">samples =</span> <span class="fl">1e3</span>, <span class="dt">pb_markdown =</span>  <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Running MCMC for K = 3
## Burn-in phase
## 
  |                                                                       
  |=================================================================| 100%
##    converged within 200 iterations
## Sampling phase
## 
  |                                                                       
  |=================================================================| 100%
##    completed in 0.408589 seconds
## 
## Processing results</code></pre>
<pre><code>## Total run-time: 0.71 seconds</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_e_quantiles.html">plot_e_quantiles</a></span>(myproj_errors)</code></pre></div>
<pre><code>## using K = 3 by default</code></pre>
<p><img src="complex-priors_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bob Verity.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
